From c84c1eb7d98f6c94a0eddda58b054aa1b1f78d64 Mon Sep 17 00:00:00 2001
From: IMoldovan <Iulia.Moldovan@analog.com>
Date: Thu, 6 May 2021 17:13:08 +0300
Subject: [PATCH] adv7511_vc707: Bring back clean

---
 projects/adv7511/vc707/Makefile           |  3 -
 projects/adv7511/vc707/system_bd.tcl      | 92 ++++++++++++++++++++++-
 projects/adv7511/vc707/system_project.tcl | 10 +--
 3 files changed, 94 insertions(+), 11 deletions(-)

diff --git a/projects/adv7511/vc707/Makefile b/projects/adv7511/vc707/Makefile
index 0870659e..ed00f208 100644
--- a/projects/adv7511/vc707/Makefile
+++ b/projects/adv7511/vc707/Makefile
@@ -9,12 +9,9 @@ M_DEPS += ../../scripts/adi_pd.tcl
 M_DEPS += ../../common/vc707/vc707_system_mig.prj
 M_DEPS += ../../common/vc707/vc707_system_constr.xdc
 M_DEPS += ../../common/vc707/vc707_system_bd.tcl
-M_DEPS += ../../adv7511/common/adv7511_bd.tcl
 M_DEPS += ../../../library/common/ad_iobuf.v
 
 LIB_DEPS += axi_clkgen
-#LIB_DEPS += axi_dmac 
 LIB_DEPS += axi_hdmi_tx
 LIB_DEPS += axi_spdif_tx
 LIB_DEPS += axi_sysid
diff --git a/projects/adv7511/vc707/system_bd.tcl b/projects/adv7511/vc707/system_bd.tcl
index 2c5356e9..1c5e0807 100644
--- a/projects/adv7511/vc707/system_bd.tcl
+++ b/projects/adv7511/vc707/system_bd.tcl
@@ -1,9 +1,97 @@
 
 source $ad_hdl_dir/projects/common/vc707/vc707_system_bd.tcl
-source $ad_hdl_dir/projects/adv7511/common/adv7511_bd.tcl
 source $ad_hdl_dir/projects/scripts/adi_pd.tcl
 
-#system ID
+# video
+
+create_bd_port -dir O hdmi_out_clk
+create_bd_port -dir O hdmi_36_hsync
+create_bd_port -dir O hdmi_36_vsync
+create_bd_port -dir O hdmi_36_data_e
+create_bd_port -dir O -from 35 -to 0 hdmi_36_data
+
+# spdif audio
+
+create_bd_port -dir O spdif
+
+# hdmi peripherals
+
+ad_ip_instance axi_clkgen axi_hdmi_clkgen
+ad_ip_instance axi_hdmi_tx axi_hdmi_core
+ad_ip_parameter axi_hdmi_core CONFIG.INTERFACE 36_BIT
+
+ad_ip_instance axi_vdma axi_hdmi_dma
+ad_ip_parameter axi_hdmi_dma CONFIG.c_m_axis_mm2s_tdata_width 64
+ad_ip_parameter axi_hdmi_dma CONFIG.c_use_mm2s_fsync 1
+ad_ip_parameter axi_hdmi_dma CONFIG.c_include_s2mm 0
+
+# audio peripherals
+
+ad_ip_instance clk_wiz sys_audio_clkgen
+ad_ip_parameter sys_audio_clkgen CONFIG.CLKOUT1_REQUESTED_OUT_FREQ 12.288
+ad_ip_parameter sys_audio_clkgen CONFIG.USE_LOCKED false
+ad_ip_parameter sys_audio_clkgen CONFIG.USE_RESET false
+ad_ip_parameter sys_audio_clkgen CONFIG.USE_PHASE_ALIGNMENT false
+ad_ip_parameter sys_audio_clkgen CONFIG.PRIM_SOURCE No_buffer
+
+ad_ip_instance axi_spdif_tx axi_spdif_tx_core
+ad_ip_parameter axi_spdif_tx_core CONFIG.DMA_TYPE 0
+ad_ip_parameter axi_spdif_tx_core CONFIG.S_AXI_ADDRESS_WIDTH 16
+
+ad_ip_instance axi_dma axi_spdif_tx_dma
+ad_ip_parameter axi_spdif_tx_dma CONFIG.C_INCLUDE_S2MM 0
+ad_ip_parameter axi_spdif_tx_dma CONFIG.C_SG_INCLUDE_STSCNTRL_STRM 0
+
+# hdmi
+
+ad_connect  sys_200m_clk axi_hdmi_clkgen/clk
+ad_connect  sys_cpu_clk axi_hdmi_core/vdma_clk
+ad_connect  sys_cpu_clk axi_hdmi_dma/m_axis_mm2s_aclk
+
+ad_connect  axi_hdmi_core/hdmi_clk axi_hdmi_clkgen/clk_0
+ad_connect  axi_hdmi_core/hdmi_out_clk hdmi_out_clk 
+ad_connect  hdmi_36_hsync axi_hdmi_core/hdmi_36_hsync  
+ad_connect  hdmi_36_vsync axi_hdmi_core/hdmi_36_vsync  
+ad_connect  hdmi_36_data_e axi_hdmi_core/hdmi_36_data_e 
+ad_connect  hdmi_36_data axi_hdmi_core/hdmi_36_data   
+ad_connect  axi_hdmi_dma/m_axis_mm2s_tvalid axi_hdmi_core/vdma_valid 	 
+ad_connect  axi_hdmi_dma/m_axis_mm2s_tdata axi_hdmi_core/vdma_data 	 
+ad_connect  axi_hdmi_dma/m_axis_mm2s_tready	axi_hdmi_core/vdma_ready 	 
+
+
+# spdif audio
+
+ad_connect  axi_spdif_tx_core/S_AXIS_TVALID axi_spdif_tx_dma/m_axis_mm2s_tvalid
+ad_connect  axi_spdif_tx_core/S_AXIS_TDATA axi_spdif_tx_dma/m_axis_mm2s_tdata
+ad_connect  axi_spdif_tx_core/S_AXIS_TLAST axi_spdif_tx_dma/m_axis_mm2s_tlast
+ad_connect  axi_spdif_tx_core/S_AXIS_TREADY axi_spdif_tx_dma/m_axis_mm2s_tready
+ad_connect  sys_200m_clk sys_audio_clkgen/clk_in1
+ad_connect  sys_audio_clkgen/clk_out1 axi_spdif_tx_core/spdif_data_clk
+ad_connect  sys_cpu_clk axi_spdif_tx_core/S_AXIS_ACLK
+ad_connect  sys_cpu_resetn axi_spdif_tx_core/S_AXIS_ARESETN
+ad_connect  spdif axi_spdif_tx_core/spdif_tx_o
+
+# processor interconnects
+
+ad_cpu_interconnect 0x79000000 axi_hdmi_clkgen
+ad_cpu_interconnect 0x70e00000 axi_hdmi_core
+ad_cpu_interconnect 0x43000000 axi_hdmi_dma
+ad_cpu_interconnect 0x75c00000 axi_spdif_tx_core
+ad_cpu_interconnect 0x41E00000 axi_spdif_tx_dma
+
+# memory interconnects
+
+ad_mem_hp0_interconnect sys_cpu_clk axi_hdmi_dma/M_AXI_MM2S
+ad_mem_hp0_interconnect sys_cpu_clk axi_spdif_tx_dma/M_AXI_SG
+ad_mem_hp0_interconnect sys_cpu_clk axi_spdif_tx_dma/M_AXI_MM2S
+
+# interrupts
+
+ad_cpu_interrupt ps-0 mb-8  axi_hdmi_dma/mm2s_introut
+ad_cpu_interrupt ps-0 mb-7  axi_spdif_tx_dma/mm2s_introut
+
+
+# system id
 ad_ip_parameter axi_sysid_0 CONFIG.ROM_ADDR_BITS 9
 ad_ip_parameter rom_sys_0 CONFIG.PATH_TO_FILE "[pwd]/mem_init_sys.txt"
 ad_ip_parameter rom_sys_0 CONFIG.ROM_ADDR_BITS 9
diff --git a/projects/adv7511/vc707/system_project.tcl b/projects/adv7511/vc707/system_project.tcl
index 857a399d..8eec40d1 100644
--- a/projects/adv7511/vc707/system_project.tcl
+++ b/projects/adv7511/vc707/system_project.tcl
@@ -5,11 +5,9 @@ source $ad_hdl_dir/projects/scripts/adi_board.tcl
 
 adi_project adv7511_vc707
 adi_project_files adv7511_vc707 [list \
-                  "system_top.v" \
-				  "system_constr.xdc" \
-                  "$ad_hdl_dir/projects/adv7511/common/adv7511_bd.tcl" \
-                  "$ad_hdl_dir/projects/common/vc707/vc707_system_constr.xdc" \
-				  "$ad_hdl_dir/library/common/ad_iobuf.v" ]
+  "system_top.v" \
+  "system_constr.xdc" \
+  "$ad_hdl_dir/projects/common/vc707/vc707_system_constr.xdc" \
+  "$ad_hdl_dir/library/common/ad_iobuf.v" ]
 
 adi_project_run adv7511_vc707
-
-- 
2.26.2

